# ü¶ä Awhar Butler - Serverpod Backend

> **The intelligent backend that powers Awhar Butler**

This is the **Serverpod 3.1.1 backend** that handles all business logic, data management, and automation for the Awhar Butler platform.

---

## üéØ What This Backend Does

**Awhar Server** is the brain of the entire platform. It handles:

‚úÖ **34 Type-Safe Protocol Models** ‚Äî Every data structure defined in YAML  
‚úÖ **30+ API Endpoints** ‚Äî Complete REST API for mobile and web apps  
‚úÖ **Automatic Price Calculation** ‚Äî Distance-based pricing engine  
‚úÖ **Real-Time Location Updates** ‚Äî Track drivers every 10 seconds  
‚úÖ **Background Automation** ‚Äî Auto-cleanup inactive drivers  
‚úÖ **Authentication & Authorization** ‚Äî Firebase Auth + JWT tokens  
‚úÖ **Database Migrations** ‚Äî 27 tracked schema evolutions  
‚úÖ **Push Notifications** ‚Äî Firebase Cloud Messaging integration  

---

## üèóÔ∏è Architecture

### Serverpod Structure

```
awhar_server/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ protocol/              # 34 YAML protocol definitions
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.yaml
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ service_request.yaml
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ order.yaml
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ driver_profile.yaml
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (30 more models)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generated/             # Auto-generated by Serverpod
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ protocol.dart      # All protocol classes
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ endpoints.dart     # Endpoint registration
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (30,000+ lines)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ endpoints/             # 30+ Business logic endpoints
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_endpoint.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ request_endpoint.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ driver_endpoint.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ store_endpoint.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ order_endpoint.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ transaction_endpoint.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ... (24 more endpoints)
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/              # Background services
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ driver_cleanup_service.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification_service.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pricing_service.dart
‚îÇ   ‚îÇ   ‚îÇ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ web/                   # Web routes
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ root.dart
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ deep_link_routes.dart
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ server.dart                # Server configuration
‚îÇ
‚îú‚îÄ‚îÄ config/                        # Environment configurations
‚îÇ   ‚îú‚îÄ‚îÄ development.yaml           # Local development
‚îÇ   ‚îú‚îÄ‚îÄ staging.yaml               # Staging environment
‚îÇ   ‚îú‚îÄ‚îÄ production.yaml            # Production settings
‚îÇ   ‚îî‚îÄ‚îÄ generator.yaml             # Serverpod generator config
‚îÇ
‚îú‚îÄ‚îÄ migrations/                    # Database migrations (27 total)
‚îÇ   ‚îú‚îÄ‚îÄ 20251225161015895/
‚îÇ   ‚îú‚îÄ‚îÄ 20260104004047863/
‚îÇ   ‚îî‚îÄ‚îÄ ... (25 more migrations)
‚îÇ
‚îú‚îÄ‚îÄ docker-compose.yaml            # PostgreSQL + Redis setup
‚îî‚îÄ‚îÄ bin/
    ‚îî‚îÄ‚îÄ main.dart                  # Server entry point
```

---

## üöÄ Quick Start

### Prerequisites

- **Dart SDK**: 3.6 or higher
- **Docker Desktop**: For PostgreSQL and Redis
- **Firebase Project**: For authentication

### 1. Install Dependencies

```bash
dart pub get
```

### 2. Start Database

```bash
# Start PostgreSQL and Redis containers
docker-compose up -d
```

This creates:
- **PostgreSQL**: `localhost:8090`
- **Redis**: `localhost:8091` (optional cache)

### 3. Apply Database Migrations

```bash
# Creates all 34 tables with indexes
dart run bin/main.dart --apply-migrations
```

### 4. Start the Server

```bash
dart run bin/main.dart
```

**Server runs on**: `http://localhost:8080`

---

## üìã Protocol Models (34 Total)

All models defined in `lib/src/protocol/*.yaml`:

### Core Models
- **user.yaml** ‚Äî Base user with Firebase UID
- **driver_profile.yaml** ‚Äî Driver data (vehicle, rating, stats)
- **service_request.yaml** ‚Äî Client service requests
- **driver_service.yaml** ‚Äî Services offered by drivers

### Order & Store Models
- **order.yaml** ‚Äî Store orders
- **order_item.yaml** ‚Äî Products in orders
- **store.yaml** ‚Äî Store information
- **store_order.yaml** ‚Äî Store-specific orders
- **store_delivery_request.yaml** ‚Äî Delivery coordination

### Payment Models
- **transaction.yaml** ‚Äî Payment records
- **wallet.yaml** ‚Äî User balances
- **payment.yaml** ‚Äî Payment processing
- **promo.yaml** ‚Äî Promo codes and discounts

### Location Models
- **location.yaml** ‚Äî GPS coordinates
- **driver_location.yaml** ‚Äî Real-time driver positions
- **address.yaml** ‚Äî Saved addresses

### Communication Models
- **chat_message.yaml** ‚Äî Message content
- **chat_participants_info.yaml** ‚Äî Chat metadata
- **user_notification.yaml** ‚Äî Push notification records

### Additional Models
- **rating.yaml** ‚Äî Reviews and ratings
- **review.yaml** ‚Äî Detailed reviews
- **dispute.yaml** ‚Äî Dispute management
- **blocked_user.yaml** ‚Äî User blocking

**Full list**: See `lib/src/protocol/`

---

## üõ£Ô∏è API Endpoints (30+ Total)

All endpoints in `lib/src/endpoints/`:

### Authentication
```dart
// auth_endpoint.dart
- authenticateWithFirebase(firebaseToken)
- refreshToken(refreshToken)
- logout(userId)
```

### User Management
```dart
// user_endpoint.dart
- getUser(userId)
- updateUser(user)
- deleteUser(userId)
```

### Driver Operations
```dart
// driver_endpoint.dart
- updateLocation(userId, location)
- setAvailability(userId, status)
- getDriverProfile(userId)
- updateDriverProfile(profile)

// driver_status_endpoint.dart
- goOnline(userId)
- goOffline(userId)
- getNearbyDrivers(location, radius)
```

### Service Requests
```dart
// request_endpoint.dart
- createRequest(request)          // Auto-calculates price
- getActiveRequests(userId)
- cancelRequest(requestId)

// proposal_endpoint.dart
- submitProposal(driverId, requestId, price)
- acceptProposal(proposalId)
- rejectProposal(proposalId)
```

### Store & Orders
```dart
// store_endpoint.dart
- createStore(store)
- updateStore(store)
- getStoresByCategory(category)

// order_endpoint.dart
- createOrder(order)
- getOrderStatus(orderId)
- updateOrderStatus(orderId, status)

// store_delivery_endpoint.dart
- createDeliveryRequest(orderId)
- assignDriver(deliveryId, driverId)
- trackDelivery(deliveryId)
```

### Payments
```dart
// transaction_endpoint.dart
- processPayment(payment)
- getTransactionHistory(userId)
- refundTransaction(transactionId)

// promo_endpoint.dart
- applyPromoCode(userId, code)
- validatePromo(code)
```

### Notifications
```dart
// notification_endpoint.dart
- sendNotification(userId, message)
- getNotifications(userId)
- markAsRead(notificationId)
```

---

## ‚öôÔ∏è Background Services

### Driver Cleanup Service

**Purpose**: Automatically marks inactive drivers as offline

**Location**: `lib/src/services/driver_cleanup_service.dart`

**Schedule**: Runs every 60 seconds

**Logic**:
```dart
// Find drivers with no location update in 5+ minutes
final inactiveDrivers = await DriverLocation.db.find(
  session,
  where: (t) => t.lastUpdate < DateTime.now().subtract(Duration(minutes: 5)),
);

// Mark each as offline
for (var driver in inactiveDrivers) {
  await DriverProfile.db.updateRow(
    session,
    driver.copyWith(availabilityStatus: DriverAvailabilityStatus.offline),
  );
}
```

**Registered in** `lib/server.dart`:
```dart
pod.schedule(
  'driver-cleanup',
  Duration(minutes: 1),
  (session) => DriverCleanupService.run(session),
);
```

---

## üóÑÔ∏è Database

**PostgreSQL 14+** managed entirely by Serverpod

### Tables (34 Total)

Created automatically from protocol models:
- `users`
- `driver_profiles`
- `service_requests`
- `orders`
- `transactions`
- `wallets`
- `driver_locations`
- `chat_messages`
- ... (26 more tables)

### Indexes

50+ indexes for query optimization:
- Location-based queries (lat/lng)
- User lookups (Firebase UID)
- Time-based queries (timestamps)
- Status filtering (enums)

### Migrations

**27 tracked migrations** in `migrations/`:
- Initial schema setup
- New tables for features
- Index optimization
- Column modifications

**Apply migrations**:
```bash
dart run bin/main.dart --apply-migrations
```

**Create new migration**:
```bash
dart run serverpod_cli create-migration
```

---

## üî• Firebase Integration

### Firebase Services Used

**Authentication**:
- Google Sign-In
- Email/Password
- Phone Authentication (+212 Morocco)

**Cloud Messaging**:
- Push notifications to drivers
- Order updates to clients
- Real-time alerts

**Admin SDK**:
- User management
- Token verification
- Located in: `config/awhar-5afc5-firebase-adminsdk-fbsvc-7175139fdc.json`

### Configuration

**Firebase Auth Integration**:
```dart
// lib/src/endpoints/auth_endpoint.dart
Future<AuthResponse> authenticateWithFirebase(
  Session session,
  String firebaseToken,
) async {
  // Verify Firebase token
  final firebaseUid = await _verifyFirebaseToken(firebaseToken);
  
  // Get or create user in database
  final user = await User.db.findFirstRow(
    session,
    where: (t) => t.firebaseUid.equals(firebaseUid),
  );
  
  // Generate JWT for Serverpod API
  final jwtToken = await _generateJwtToken(user.id);
  
  return AuthResponse(
    user: user,
    token: jwtToken,
    refreshToken: refreshToken,
  );
}
```

---

## üß™ Testing

### Run Server Tests

```bash
dart test
```

### Integration Tests

Located in `test/integration/`:
```dart
withServerpod('Given User endpoint', (sessionBuilder, endpoints) {
  test('when creating user then returns user with ID', () async {
    final user = await endpoints.user.createUser(
      sessionBuilder,
      User(name: 'Test User', email: 'test@example.com'),
    );
    expect(user.id, isNotNull);
  });
});
```

### API Testing with Postman

**Base URL**: `http://localhost:8080`

**Example: Create Service Request**
```http
POST http://localhost:8080/request/createRequest
Content-Type: application/json

{
  "userId": 1,
  "title": "Ride to Airport",
  "pickup": {
    "latitude": 33.5731,
    "longitude": -7.5898,
    "address": "Casa Port"
  },
  "dropoff": {
    "latitude": 33.3675,
    "longitude": -7.5898,
    "address": "Mohammed V Airport"
  }
}
```

**Response**:
```json
{
  "id": 123,
  "userId": 1,
  "title": "Ride to Airport",
  "distance": 24.5,
  "calculatedPrice": 142.5,
  "status": "pending"
}
```

---

## üìä Key Features

### 1. Auto-Pricing Engine

**Location**: `lib/src/endpoints/request_endpoint.dart`

```dart
double _calculatePrice(ServiceRequest request) {
  // Calculate distance using Haversine formula
  final distance = _calculateDistance(
    request.pickup,
    request.dropoff,
  );
  
  // Apply service-type rates
  final rate = switch (request.serviceType) {
    ServiceType.ride => 5.0,      // 5 MAD/km
    ServiceType.delivery => 3.0,  // 3 MAD/km
    ServiceType.moving => 8.0,    // 8 MAD/km
    ServiceType.shopping => 4.0,  // 4 MAD/km
  };
  
  // Calculate: distance √ó rate
  final price = distance * rate;
  
  // Validate range (15-500 MAD)
  return price.clamp(15.0, 500.0);
}
```

### 2. Real-Time Location Broadcasting

**Update Every 10 Seconds**:

```dart
// lib/src/endpoints/location_endpoint.dart
Future<void> updateLocation(
  Session session,
  int userId,
  Location location,
) async {
  await DriverLocation.db.insertRow(
    session,
    DriverLocation(
      userId: userId,
      latitude: location.latitude,
      longitude: location.longitude,
      lastUpdate: DateTime.now(),
    ),
  );
}
```

**Clients Query Latest Position**:
```dart
final location = await DriverLocation.db.findFirstRow(
  session,
  where: (t) => t.userId.equals(driverId),
  orderBy: (t) => t.lastUpdate,
  orderDescending: true,
);
```

### 3. Smart Driver Discovery

**Find Nearby Drivers**:
```dart
Future<List<NearbyDriver>> findNearbyDrivers(
  Session session,
  Location clientLocation,
  double radiusKm,
) async {
  // Get all online drivers
  final onlineDrivers = await DriverProfile.db.find(
    session,
    where: (t) => t.availabilityStatus.equals(
      DriverAvailabilityStatus.online
    ),
  );
  
  // Filter by distance
  final nearby = onlineDrivers.where((driver) {
    final distance = _calculateDistance(
      clientLocation,
      driver.lastKnownLocation,
    );
    return distance <= radiusKm;
  }).toList();
  
  // Sort by rating
  nearby.sort((a, b) => b.rating.compareTo(a.rating));
  
  return nearby;
}
```

---

## üîß Configuration Files

### development.yaml (Local)

```yaml
apiServer:
  port: 8080
  publicHost: localhost
  publicPort: 8080
  publicScheme: http

database:
  host: localhost
  port: 8090
  name: awhar_backend
  user: postgres
  password: postgres

redis:
  enabled: false

storage:
  public:
    type: file
    path: ./storage/public
```

### production.yaml

```yaml
apiServer:
  port: 8080
  publicHost: awhar.io
  publicScheme: https

database:
  host: ${POSTGRES_HOST}
  port: 5432
  name: ${POSTGRES_DB}
  user: ${POSTGRES_USER}
  password: ${POSTGRES_PASSWORD}

redis:
  enabled: true
  host: ${REDIS_HOST}

storage:
  public:
    type: s3
    bucket: awhar-storage
```

---

## üö¢ Deployment

### Docker Deployment

```bash
# Build Docker image
docker build -t awhar-server .

# Run container
docker run -p 8080:8080 \
  -e POSTGRES_HOST=db.awhar.io \
  -e POSTGRES_DB=awhar_prod \
  awhar-server
```

### Serverpod Cloud

```bash
# Deploy to Serverpod Cloud
serverpod deploy production
```

---

## üìö Resources

**Serverpod Documentation**: https://docs.serverpod.dev

**Key Topics**:
- [Protocol Models](https://docs.serverpod.dev/concepts/models)
- [Endpoints](https://docs.serverpod.dev/concepts/endpoints)
- [Database Queries](https://docs.serverpod.dev/concepts/database)
- [Background Jobs](https://docs.serverpod.dev/concepts/scheduling)
- [Authentication](https://docs.serverpod.dev/concepts/authentication)

---

## üéØ Demo Accounts

Test the API with pre-configured accounts:

| Email | Password | Role |
|-------|----------|------|
| `mohamed.driver@awhar.demo` | `Demo123` | Driver |
| `sarah.client@awhar.demo` | `Demo123` | Client |
| `pizza.express@awhar.demo` | `Demo123` | Store |

**Full details**: See [/docs/DEMO_ACCOUNTS.md](../docs/DEMO_ACCOUNTS.md)

---

## üí° Why Serverpod?

**This backend wouldn't exist without Serverpod.**

- ‚úÖ **34 Protocol Models** ‚Üí 30,000+ lines of generated code
- ‚úÖ **Zero Boilerplate** ‚Üí Focus on business logic
- ‚úÖ **Type Safety** ‚Üí From database to API to client
- ‚úÖ **Automatic Migrations** ‚Üí Evolve schema safely
- ‚úÖ **Background Jobs** ‚Üí Built-in scheduling
- ‚úÖ **Production Ready** ‚Üí Auth, logging, error handling included

**Serverpod made it possible to build a production platform as a solo developer in weeks.**

---

<div align="center">

**ü¶ä Awhar Butler Backend**

*Built with [Serverpod](https://serverpod.dev)*

[Main Repository](https://github.com/FouadABT/awhar-butler) ‚Ä¢ [Documentation](../docs/)

</div>
